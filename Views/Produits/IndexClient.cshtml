@using System.Linq
@model IEnumerable<gestion_pharma.Models.Entities.Produit>

@{
    ViewData["Title"] = "Catalogue";
}

<!-- Floating Cart Button -->
<div style="position: fixed; top: 90px; right: 20px; z-index: 999;">
    <a asp-controller="Cart" asp-action="Index" class="btn btn-primary btn-lg rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" title="Aller au panier" aria-label="Panier">
        <i class="bi bi-cart3" style="font-size: 24px;"></i>
    </a>
</div>

<header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Nos Produits</h1>
            <p class="lead fw-normal text-white-50 mb-4">La meilleure qualitÃ© pour votre santÃ©</p>
            <form asp-action="IndexClient" method="get" class="d-flex justify-content-center">
                <div class="input-group mb-3" style="max-width: 500px;">
                    <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control" placeholder="Rechercher un produit..." aria-label="Rechercher un produit" aria-describedby="button-search">
                    <button class="btn btn-primary" type="submit" id="button-search">Rechercher</button>
                    @if (ViewData["CurrentFilter"] != null)
                    {
                        <a asp-action="IndexClient" class="btn btn-outline-light ms-2">Tout afficher</a>
                    }
                </div>
            </form>
        </div>
    </div>
</header>

<section class="py-5">
    <div class="container px-4 px-lg-5 mt-5">
        <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
            @foreach (var item in Model)
            {
                <div class="col mb-5">
                    <div class="card h-100">
                        <!-- Product image-->
                        <img class="card-img-top" src="@item.ImagePath" alt="@item.Nom" style="height: 200px; object-fit: cover;" />
                        <!-- Product details-->
                        <div class="card-body p-4">
                            <div class="text-center">
                                <!-- Product name-->
                                <h5 class="fw-bolder">@item.Nom</h5>
                                <!-- Product review-->
                                <div class="d-flex justify-content-center small text-warning mb-2">
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                    <div class="bi-star-fill"></div>
                                </div>
                                <!-- Product price-->
                                @item.Prix.ToString("C")
                            </div>
                        </div>
                        <!-- Product actions-->
                        <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                            <div class="text-center d-flex justify-content-center gap-2">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-info mt-auto">Voir</a>
                                <a asp-controller="Cart" asp-action="AddToCart" asp-route-productId="@item.Id" asp-route-quantity="1" class="btn btn-outline-dark mt-auto">Ajouter au panier</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<link rel="stylesheet" href="~/css/chatbot.css" />

<!-- Bouton du chatbot -->
<div id="chatbot-toggle" class="chatbot-toggle">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
        <path d="M6 12h12v2H6zm0-3h12v2H6zm0-3h12v2H6z"/>
    </svg>
</div>

<!-- FenÃªtre de chat -->
<div id="chatbot-window" class="chatbot-window">
    <div class="chatbot-header">
        <h3>Conseiller BeautÃ©</h3>
        <button id="chatbot-close" class="chatbot-close">&times;</button>
    </div>
    
    <div id="chatbot-messages" class="chatbot-messages">
        <!-- Messages apparaÃ®tront ici -->
    </div>
    
    <div class="chatbot-input">
        <input 
            type="text" 
            id="chatbot-input" 
            placeholder="DÃ©crivez votre peau ou posez une question..."
            autocomplete="off"
        >
        <button id="chatbot-send">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </div>
</div>

<script>
    // Integration avec les vraies donnÃ©es (TEST DEBUG)
    const realProducts = [];

    // Base de connaissances enrichie
    const productKnowledgeBase = {
        products: realProducts,
        categories: {
            "promotions": {
                keywords: ["promo", "promotion", "rÃ©duction", "solde", "offre", "rabais", "bon plan", "moins cher"],
                response: "ğŸ”¥ Voici nos offres spÃ©ciales du moment :",
                action: "showPromotions"
            },
            
            "types_peau": {
                keywords: ["peau", "type de peau", "peau sensible", "acnÃ©ique", "grasse", "sÃ¨che", "mixte", "normale", "atopique"],
                response: "Je peux vous recommander des produits adaptÃ©s Ã  votre type de peau. Quel est votre type de peau ?",
                action: "askSkinTypeDetails"
            },
            
            "problÃ¨mes_peau": {
                keywords: ["acnÃ©", "boutons", "points noirs", "imperfections", "rougeurs", "irritation", "dÃ©mangeaisons", "tiraillements", "brillances"],
                response: "Nous avons des solutions spÃ©cifiques pour ces problÃ¨mes. Pouvez-vous prÃ©ciser ?",
                action: "askSkinProblemDetails"
            },
            
            "routine": {
                keywords: ["routine", "soin", "Ã©tapes", "nettoyage", "hydratation", "crÃ¨me", "sÃ©rum", "masque", "exfoliation"],
                response: "Je peux vous aider Ã  Ã©tablir une routine adaptÃ©e. Quel est votre objectif principal ?",
                action: "askRoutineGoal"
            },
            
            "ingrÃ©dients": {
                keywords: ["ingrÃ©dient", "composition", "actif", "acide hyaluronique", "niacinamide", "rÃ©tinol", "vitamine C", "salicylique", "ceramides"],
                response: "Je peux vous conseiller sur les actifs. Quel ingrÃ©dient vous intÃ©resse ?",
                action: "explainIngredient"
            },
            
            "marques": {
                keywords: ["marque", "brand", "la roche-posay", "avÃ¨ne", "cetaphil", "bioderma", "vichy", "caudalie", "cerave"],
                response: "Voici nos marques phares :",
                action: "showBrands"
            },
            
            "avis": {
                keywords: ["avis", "test", "commentaire", "note", "Ã©valuation", "retour", "expÃ©rience"],
                response: "Nos produits les mieux notÃ©s :",
                action: "showTopRated"
            },
            
            "nouveautÃ©s": {
                keywords: ["nouveau", "nouveautÃ©", "rÃ©cent", "sortie", "derniÃ¨re collection", "inÃ©dit"],
                response: "ğŸ‰ DÃ©couvrez nos derniÃ¨res nouveautÃ©s :",
                action: "showNewArrivals"
            },
            
            "budget": {
                keywords: ["budget", "prix", "coÃ»t", "cher", "abordables", "Ã©conomique", "luxe", "premium", "entrÃ©e de gamme"],
                response: "Nous avons des options pour tous les budgets. Quel est votre fourchette de prix ?",
                action: "askBudgetRange"
            },
            
            "livraison": {
                keywords: ["livraison", "transport", "dÃ©lai", "gratuit", "express", "frais de port", "suivi", "expÃ©dition"],
                response: "ğŸ“¦ Informations sur la livraison :",
                action: "showDeliveryInfo"
            },
            
            "paiement": {
                keywords: ["paiement", "payer", "carte", "virement", "paypal", "espÃ¨ces", "sÃ©curisÃ©", "transaction"],
                response: "ğŸ’³ Informations sur le paiement :",
                action: "showPaymentInfo"
            },
            
            "retour": {
                keywords: ["retour", "remboursement", "Ã©change", "garantie", "satisfaction", "politique retour"],
                response: "ğŸ”„ Politique de retour et remboursement :",
                action: "showReturnPolicy"
            },
            
            "contact": {
                keywords: ["contact", "tÃ©lÃ©phone", "email", "support", "aide", "service client", "nous contacter"],
                response: "ğŸ“ Comment nous contacter :",
                action: "showContact"
            },
            
            "conseil_expert": {
                keywords: ["conseil", "expert", "dermatologue", "spÃ©cialiste", "consultation", "avis professionnel"],
                response: "ğŸ‘¨â€âš•ï¸ Services de conseil expert :",
                action: "showExpertServices"
            },
            
            "allergie": {
                keywords: ["allergie", "allergique", "sensibilitÃ©", "intolÃ©rance", "rÃ©action", "hypoallergÃ©nique"],
                response: "âš ï¸ Produits hypoallergÃ©niques :",
                action: "showHypoallergenicProducts"
            },
            
            "age": {
                keywords: ["enfant", "bÃ©bÃ©", "ado", "adolescent", "Ã¢ge", "enfants", "jeune", "mature", "anti-Ã¢ge"],
                response: "ğŸ‘¶ Produits adaptÃ©s Ã  votre Ã¢ge :",
                action: "showAgeAppropriateProducts"
            },
            
            "homme_femme": {
                keywords: ["homme", "femme", "hommes", "femmes", "masculin", "fÃ©minin", "spÃ©cifique"],
                response: "ğŸ‘¥ Produits spÃ©cifiques :",
                action: "showGenderSpecific"
            }
        },
        
        skinTypes: {
            "sensible": {
                description: "Peau qui rÃ©agit facilement (rougeurs, picotements)",
                recommendations: ["Produits sans parfum", "Soins apaisants", "Texture lÃ©gÃ¨re"],
                products:  realProducts.slice(0, 3).map(p => p.id) // Fallback dynamique
            },
            "acnÃ©ique": {
                description: "Peau Ã  tendance acnÃ©ique avec imperfections",
                recommendations: ["Nettoyants purifiants", "Soins non comÃ©dogÃ¨nes", "Actifs anti-imperfections"],
                products: realProducts.slice(0, 3).map(p => p.id)
            },
            "grasse": {
                description: "Peau qui brille avec pores dilatÃ©s",
                recommendations: ["Gels nettoyants", "Textures matifiantes", "ContrÃ´le sÃ©bum"],
                products: realProducts.slice(0, 3).map(p => p.id)
            },
            "sÃ¨che": {
                description: "Peau qui tiraille, manque de confort",
                recommendations: ["CrÃ¨mes riches", "Soins nourrissants", "Actifs hydratants"],
                products: realProducts.slice(0, 3).map(p => p.id)
            },
            "mixte": {
                description: "Zone T grasse, joues sÃ¨ches",
                recommendations: ["Soins Ã©quilibrants", "Textures fluides", "Zoning possible"],
                products: realProducts.slice(0, 3).map(p => p.id)
            },
            "normale": {
                description: "Peau Ã©quilibrÃ©e sans problÃ¨me majeur",
                recommendations: ["Soins d'entretien", "PrÃ©vention", "Confort quotidien"],
                products: realProducts.slice(0, 3).map(p => p.id)
            }
        },
        
        skinProblems: {
            "acnÃ©": {
                severity: ["lÃ©gÃ¨re", "modÃ©rÃ©e", "sÃ©vÃ¨re"],
                solutions: ["Nettoyant salicylique", "SÃ©rum niacinamide", "CrÃ¨me non comÃ©dogÃ¨ne"]
            },
            "rougeurs": {
                causes: ["couperose", "rosacÃ©e", "sensibilitÃ©"],
                solutions: ["Soins apaisants", "Actifs anti-rougeurs", "Protection SPF"]
            },
            "dÃ©shydratation": {
                symptoms: ["tiraillements", "desquamation", "inconfort"],
                solutions: ["Acide hyaluronique", "CrÃ¨mes hydratantes", "Masques intensifs"]
            },
            "signes_age": {
                types: ["rides", "ridules", "perte fermetÃ©", "taches"],
                solutions: ["RÃ©tinol", "Vitamine C", "Peptides", "SPF quotidien"]
            },
            "pores_dilatÃ©s": {
                causes: ["excÃ¨s sÃ©bum", "manque exfoliation"],
                solutions: ["Exfoliants chimiques", "Argile purifiante", "SÃ©rums matifiants"]
            }
        },
        
        routineSteps: {
            "matin": ["Nettoyage doux", "SÃ©rum antioxydant", "CrÃ¨me hydratante SPF"],
            "soir": ["DÃ©maquillage", "Nettoyage", "SÃ©rum traitement", "CrÃ¨me de nuit"],
            "hebdomadaire": ["Exfoliation 1-2x/semaine", "Masque traitement", "Soin contour yeux"]
        },
        
        serviceInfo: {
            "delivery": {
                title: "ğŸ“¦ Livraison",
                content: "âœ… Livraison gratuite Ã  partir de 50â‚¬\nâœ… Livraison express 24-48h\nâœ… Suivi de colis en temps rÃ©el\nâœ… Emballage sÃ©curisÃ© et discret",
                icon: "ğŸ“¦"
            },
            "payment": {
                title: "ğŸ’³ Paiement SÃ©curisÃ©",
                content: "âœ… Carte bancaire (Visa, Mastercard, Amex)\nâœ… Paiement en ligne sÃ©curisÃ© (SSL)\nâœ… Paiement Ã  la livraison possible\nâœ… Paiement par virement bancaire",
                icon: "ğŸ’³"
            },
            "return": {
                title: "ğŸ”„ Politique de Retour",
                content: "âœ… Retour gratuit sous 30 jours\nâœ… Remboursement rapide (5-7 jours)\nâœ… Ã‰change possible\nâœ… Garantie produits neuf et scellÃ©",
                icon: "ğŸ”„"
            },
            "contact": {
                title: "ğŸ“ Service Client",
                content: "ğŸ“§ Email: contact@pharmacare.fr\nğŸ“± TÃ©lÃ©phone: +33 1 XX XX XX XX\nğŸ’¬ Chat en ligne disponible\nâ° Lundi-Vendredi 9h-18h, Samedi 10h-16h",
                icon: "ğŸ“"
            },
            "expert": {
                title: "ğŸ‘¨â€âš•ï¸ Conseils Experts",
                content: "âœ… Consultations gratuites avec nos experts\nâœ… Recommandations personnalisÃ©es\nâœ… Diagnostic de peau en ligne\nâœ… Suivi de votre routine",
                icon: "ğŸ‘¨â€âš•ï¸"
            },
            "hypoallergenic": {
                title: "âš ï¸ Produits HypoallergÃ©niques",
                content: "âœ… Produits testÃ©s dermatologiquement\nâœ… Sans parfum synthÃ©tique\nâœ… Sans colorant artificiel\nâœ… AdaptÃ© aux peaux sensibles et rÃ©actives",
                icon: "âš ï¸"
            }
        }
    };

    // Classe Chatbot amÃ©liorÃ©e
    class EnhancedChatbotAI {
        constructor() {
            this.context = {
                currentCategory: null,
                userPreferences: {},
                conversationHistory: []
            };
        }

        processMessage(message) {
            const lowerMessage = message.toLowerCase();
            this.context.conversationHistory.push({ type: 'user', content: message });
            
            // VÃ©rifier les salutations
            if (this.isGreeting(lowerMessage)) {
                return this.getGreetingResponse();
            }
            
            // VÃ©rifier les remerciements
            if (this.isThankYou(lowerMessage)) {
                return this.getThankYouResponse();
            }
            
            // Analyser l'intention
            const intent = this.analyzeIntent(lowerMessage);
            
            // GÃ©nÃ©rer la rÃ©ponse
            return this.generateResponse(intent, message);
        }

        isGreeting(message) {
            const greetings = ['bonjour', 'salut', 'coucou', 'hello', 'hi', 'bonsoir'];
            return greetings.some(greet => message.includes(greet));
        }

        isThankYou(message) {
            const thanks = ['merci', 'thanks', 'super', 'parfait', 'gÃ©nial', 'ok'];
            return thanks.some(thank => message.includes(thank));
        }

        analyzeIntent(message) {
            const lowerMessage = message.toLowerCase();
            
            // DÃ©tection services
            if (this.isServiceQuestion(lowerMessage)) {
                const serviceType = this.extractServiceType(lowerMessage);
                if (serviceType) {
                    return { type: 'service', service: serviceType };
                }
            }
            
            // DÃ©tection peau
            if (this.isSkinTypeQuestion(lowerMessage)) {
                return { type: 'skin_type', details: this.extractSkinType(lowerMessage) };
            }
            
            // DÃ©tection problÃ¨mes
            if (this.isSkinProblemQuestion(lowerMessage)) {
                return { type: 'skin_problem', details: this.extractSkinProblem(lowerMessage) };
            }
            
            // DÃ©tection routine
            if (this.isRoutineQuestion(lowerMessage)) {
                return { type: 'routine', details: this.extractRoutineGoal(lowerMessage) };
            }
            
            // Recherche dans les catÃ©gories
            for (const [category, data] of Object.entries(productKnowledgeBase.categories)) {
                if (data.keywords.some(keyword => lowerMessage.includes(keyword))) {
                    return { type: 'category', category, data };
                }
            }
            
            // Recherche produit spÃ©cifique
            const productMatch = productKnowledgeBase.products.find(product => 
                lowerMessage.includes(product.name.toLowerCase())
            );
            
            if (productMatch) {
                return { type: 'product', product: productMatch };
            }
            
            return { type: 'unknown' };
        }
        
        isSkinTypeQuestion(message) {
            const skinTypePatterns = [
                /(ma|j'ai une) peau (sensible|acnÃ©ique|grasse|sÃ¨che|mixte|normale)/i,
                /(je suis|j'ai) (peau sensible|peau acnÃ©ique|peau grasse|peau sÃ¨che)/i,
                /(type de peau|nature de peau|quelle peau)/i,
                /(recommand).* (peau sensible|acnÃ©ique|grasse|sÃ¨che)/i
            ];
            return skinTypePatterns.some(pattern => pattern.test(message));
        }
        
        extractSkinType(message) {
            const skinTypes = Object.keys(productKnowledgeBase.skinTypes);
            for (const type of skinTypes) {
                if (message.includes(type)) {
                    return type;
                }
            }
            return null;
        }
        
        isSkinProblemQuestion(message) {
            const problemPatterns = [
                /(j'ai|avec) (acnÃ©|boutons|points noirs|imperfections)/i,
                /(rougeurs|irritations|dÃ©mangeaisons)/i,
                /(peau qui brille|excÃ¨s de sÃ©bum)/i,
                /(tiraillements|dessÃ¨chement)/i,
                /(rides|ridules|vieillissement)/i
            ];
            return problemPatterns.some(pattern => pattern.test(message));
        }
        
        extractSkinProblem(message) {
            const problems = Object.keys(productKnowledgeBase.skinProblems);
            for (const problem of problems) {
                if (message.includes(problem)) {
                    return problem;
                }
            }
            return null;
        }
        
        isRoutineQuestion(message) {
            const routinePatterns = [
                /(routine|soins) (visage|peau)/i,
                /(Ã©tapes|comment faire|appliquer)/i,
                /(nettoyer|dÃ©maquiller|hydrater)/i,
                /(matin|soir|jour|nuit)/i
            ];
            return routinePatterns.some(pattern => pattern.test(message));
        }
        
        extractRoutineGoal(message) {
            if (message.includes("matin")) return "matin";
            if (message.includes("soir") || message.includes("nuit")) return "soir";
            if (message.includes("base") || message.includes("dÃ©butant")) return "base";
            return "complete";
        }

        isServiceQuestion(message) {
            const servicePatterns = [
                /(livraison|transport|dÃ©lai)/i,
                /(paiement|payer|carte)/i,
                /(retour|remboursement|Ã©change)/i,
                /(contact|tÃ©lÃ©phone|email|support)/i,
                /(conseil|expert|dermatologue)/i,
                /(allergie|sensibilitÃ©|hypoallergÃ©nique)/i,
                /(frais de port|gratuit|express)/i
            ];
            return servicePatterns.some(pattern => pattern.test(message));
        }

        extractServiceType(message) {
            const lowerMessage = message.toLowerCase();
            if (lowerMessage.includes("livraison") || lowerMessage.includes("transport")) return "livraison";
            if (lowerMessage.includes("paiement") || lowerMessage.includes("payer")) return "paiement";
            if (lowerMessage.includes("retour") || lowerMessage.includes("remboursement")) return "retour";
            if (lowerMessage.includes("contact") || lowerMessage.includes("tÃ©lÃ©phone")) return "contact";
            if (lowerMessage.includes("conseil") || lowerMessage.includes("expert")) return "conseil_expert";
            if (lowerMessage.includes("allergie") || lowerMessage.includes("sensibilitÃ©")) return "allergie";
            return null;
        }

        generateResponse(intent, originalMessage) {
            switch (intent.type) {
                case 'service':
                    return this.generateServiceResponse(intent.service);
                    
                case 'skin_type':
                    return this.generateSkinTypeResponse(intent.details);
                    
                case 'skin_problem':
                    return this.generateSkinProblemResponse(intent.details);
                    
                case 'routine':
                    return this.generateRoutineResponse(intent.details);
                    
                case 'category':
                    this.context.currentCategory = intent.category;
                    return this.generateCategoryResponse(intent.category);
                    
                case 'product':
                    return this.generateProductResponse(intent.product);
                    
                default:
                    return this.generateFallbackResponse();
            }
        }
        
        generateServiceResponse(serviceType) {
            const serviceInfo = productKnowledgeBase.serviceInfo[serviceType];
            if (!serviceInfo) {
                return this.generateFallbackResponse();
            }
            
            return {
                text: `**${serviceInfo.title}**\n\n${serviceInfo.content}`,
                quickReplies: [
                    { text: "ğŸ“¦ Livraison", query: "livraison" },
                    { text: "ğŸ’³ Paiement", query: "paiement" },
                    { text: "ğŸ”„ Retours", query: "retour" },
                    { text: "ğŸ“ Contact", query: "contact" }
                ]
            };
        }
        
        generateSkinTypeResponse(skinType) {
            const skinInfo = productKnowledgeBase.skinTypes[skinType];
            if (!skinType) {
                return {
                    text: "Quel est votre type de peau ? Je peux vous recommander des produits adaptÃ©s.",
                    quickReplies: [
                        { text: "ğŸ‘ï¸ Peau sensible", query: "je suis sensible" },
                        { text: "âš¡ Peau acnÃ©ique", query: "peau Ã  imperfections" },
                        { text: "âœ¨ Peau grasse", query: "peau qui brille" },
                        { text: "ğŸ’§ Peau sÃ¨che", query: "peau qui tiraille" }
                    ]
                };
            }
            
            if (!skinInfo) {
                return {
                    text: `Pour la peau ${skinType}, je vous recommande :`,
                    quickReplies: [
                        { text: "ğŸ§´ Produits adaptÃ©s", query: `produits peau ${skinType}` },
                        { text: "ğŸ’¡ Routine conseillÃ©e", query: `routine ${skinType}` }
                    ]
                };
            }
            
            const recommendedProducts = productKnowledgeBase.products
                .filter(p => skinInfo.products.includes(p.id))
                .slice(0, 3);
            
            return {
                text: `**Pour la peau ${skinType} :**\n\n${skinInfo.description}\n\n**Mes recommandations :**\n${skinInfo.recommendations.join(', ')}`,
                products: recommendedProducts,
                quickReplies: [
                    { text: "ğŸ›’ Voir ces produits", query: `produits pour peau ${skinType}` },
                    { text: "ğŸ’¡ Routine conseillÃ©e", query: `routine peau ${skinType}` },
                    { text: "ğŸ¯ Autres conseils", query: "conseils personnalisÃ©s" }
                ]
            };
        }
        
        generateSkinProblemResponse(problem) {
            const problemInfo = productKnowledgeBase.skinProblems[problem];
            if (!problem) {
                return {
                    text: "Quel problÃ¨me cutanÃ© rencontrez-vous ?",
                    quickReplies: [
                        { text: "ğŸ­ AcnÃ©/imperfections", query: "j'ai des boutons" },
                        { text: "ğŸ”´ Rougeurs/sensibilitÃ©", query: "rougeurs visage" },
                        { text: "ğŸ’¦ DÃ©shydratation", query: "peau trÃ¨s sÃ¨che" },
                        { text: "â³ Signes de l'Ã¢ge", query: "premiers signes Ã¢ge" }
                    ]
                };
            }
            
            if (!problemInfo) {
                return {
                    text: `Pour ${problem}, nous avons plusieurs solutions.`,
                    quickReplies: [
                        { text: "ğŸ“‹ Voir les solutions", query: `solutions ${problem}` },
                        { text: "ğŸ§´ Produits adaptÃ©s", query: `produits ${problem}` }
                    ]
                };
            }
            
            return {
                text: `**Pour ${problem} :**\n\nSolutions recommandÃ©es :\n${problemInfo.solutions.join('\n')}`,
                quickReplies: [
                    { text: "ğŸ›’ Produits spÃ©cifiques", query: `produits pour ${problem}` },
                    { text: "ğŸ”„ Routine complÃ¨te", query: `routine ${problem}` },
                    { text: "ğŸ‘¨â€âš•ï¸ Conseils experts", query: "conseil expert" }
                ]
            };
        }
        
        generateRoutineResponse(routineType) {
            const steps = productKnowledgeBase.routineSteps[routineType] || 
                          productKnowledgeBase.routineSteps.matin;
            
            return {
                text: `**Routine ${routineType} :**\n\n${steps.map((step, i) => `${i+1}. ${step}`).join('\n')}`,
                quickReplies: [
                    { text: "ğŸ§´ Produits par Ã©tape", query: `produits routine ${routineType}` },
                    { text: "â° Routine soir", query: "routine soir" },
                    { text: "ğŸ“… Routine hebdo", query: "routine hebdomadaire" }
                ]
            };
        }
        
        generateCategoryResponse(category) {
            const categoryInfo = productKnowledgeBase.categories[category];
            const response = {
                text: categoryInfo.response,
                action: categoryInfo.action
            };
            
            switch(category) {
                case 'types_peau':
                    response.quickReplies = [
                        { text: "ğŸ‘ï¸ Peau sensible", query: "peau sensible" },
                        { text: "âš¡ Peau acnÃ©ique", query: "peau acnÃ©ique" },
                        { text: "âœ¨ Peau grasse", query: "peau grasse" },
                        { text: "ğŸ’§ Peau sÃ¨che", query: "peau sÃ¨che" }
                    ];
                    break;
                    
                case 'problÃ¨mes_peau':
                    response.quickReplies = [
                        { text: "ğŸ­ AcnÃ©", query: "acnÃ©" },
                        { text: "ğŸ”´ Rougeurs", query: "rougeurs" },
                        { text: "ğŸ’¦ SÃ©cheresse", query: "peau sÃ¨che" },
                        { text: "â³ Rides", query: "rides" }
                    ];
                    break;
                    
                case 'routine':
                    response.quickReplies = [
                        { text: "ğŸŒ… Routine matin", query: "routine matin" },
                        { text: "ğŸŒ™ Routine soir", query: "routine soir" },
                        { text: "ğŸ§– Soins hebdo", query: "soins hebdomadaires" }
                    ];
                    break;
                    
                case 'promotions':
                    const promoProducts = productKnowledgeBase.products.filter(p => p.promo);
                    response.products = promoProducts.slice(0, 3);
                    response.quickReplies = [
                        { text: "ğŸ›’ Voir toutes les promos", query: "toutes promotions" },
                        { text: "â­ Meilleures ventes", query: "best sellers" }
                    ];
                    break;
                
                case 'livraison':
                    response.text = productKnowledgeBase.serviceInfo.delivery.content;
                    response.quickReplies = [
                        { text: "ğŸ’³ Paiement", query: "paiement" },
                        { text: "ğŸ”„ Retours", query: "retour" },
                        { text: "ğŸ“ Contact", query: "contact" }
                    ];
                    break;
                    
                case 'paiement':
                    response.text = productKnowledgeBase.serviceInfo.payment.content;
                    response.quickReplies = [
                        { text: "ğŸ“¦ Livraison", query: "livraison" },
                        { text: "ğŸ”„ Retours", query: "retour" },
                        { text: "ğŸ“ Support", query: "contact" }
                    ];
                    break;
                    
                case 'retour':
                    response.text = productKnowledgeBase.serviceInfo.return.content;
                    response.quickReplies = [
                        { text: "ğŸ“¦ Livraison", query: "livraison" },
                        { text: "ğŸ’³ Paiement", query: "paiement" },
                        { text: "ğŸ“ Questions", query: "contact" }
                    ];
                    break;
                    
                case 'contact':
                    response.text = productKnowledgeBase.serviceInfo.contact.content;
                    response.quickReplies = [
                        { text: "ğŸ“¦ Livraison", query: "livraison" },
                        { text: "ğŸ”„ Retours", query: "retour" },
                        { text: "ğŸ’³ Paiement", query: "paiement" }
                    ];
                    break;
                    
                case 'conseil_expert':
                    response.text = productKnowledgeBase.serviceInfo.expert.content;
                    response.quickReplies = [
                        { text: "ğŸ‘ï¸ Diagnostic peau", query: "type de peau" },
                        { text: "ğŸ§´ Routine personnalisÃ©e", query: "routine" },
                        { text: "âš¡ ProblÃ¨mes spÃ©cifiques", query: "acnÃ©" }
                    ];
                    break;
                    
                case 'allergie':
                    response.text = productKnowledgeBase.serviceInfo.hypoallergenic.content;
                    response.quickReplies = [
                        { text: "ğŸ” Chercher produits", query: "produits hypoallergÃ©niques" },
                        { text: "ğŸ‘¨â€âš•ï¸ Conseil expert", query: "conseil expert" },
                        { text: "ğŸ“ Questions", query: "contact" }
                    ];
                    break;
            }
            
            return response;
        }
        
        generateProductResponse(product) {
            return {
                text: `**${product.name}**\nğŸ’° Prix : ${product.price}â‚¬ ${product.promo ? 'ğŸ”¥ PROMO' : ''}\nâ­ Note : ${product.rating}/5`,
                quickReplies: [
                    { text: "ğŸ“– DÃ©tails complets", query: `fiche ${product.name}` },
                    { text: "ğŸ›’ Ajouter au panier", query: `panier ${product.id}` },
                    { text: "ğŸ” Similaires", query: `similaires Ã  ${product.name}` }
                ]
            };
        }
        
        generateFallbackResponse() {
            const suggestions = [
                "Parlez-moi de votre type de peau",
                "Avez-vous des problÃ¨mes cutanÃ©s spÃ©cifiques ?",
                "Souhaitez-vous Ã©tablir une routine ?",
                "Cherchez-vous des promotions ?",
                "Besoin d'infos sur la livraison ?",
                "Des questions sur le paiement ?"
            ];
            
            return {
                text: `Je peux vous aider avec :\nâ€¢ ğŸ‘ï¸ Diagnostic et conseils peau\nâ€¢ ğŸ§´ Routines personnalisÃ©es\nâ€¢ ğŸ¯ ProblÃ¨mes spÃ©cifiques\nâ€¢ ğŸ”¥ Promotions\nâ€¢ ğŸ“¦ Livraison & retours\nâ€¢ ğŸ’³ Paiement & services\nâ€¢ ğŸ‘¨â€âš•ï¸ Conseils experts\n\n${suggestions[Math.floor(Math.random() * suggestions.length)]}`,
                quickReplies: [
                    { text: "ğŸ‘ï¸ Diagnostic peau", query: "type de peau" },
                    { text: "ğŸ“¦ Infos pratiques", query: "livraison" },
                    { text: "ğŸ‘¨â€âš•ï¸ Conseil expert", query: "conseil expert" },
                    { text: "ğŸ”¥ Promotions", query: "promotions" }
                ]
            };
        }

        getGreetingResponse() {
            return {
                text: "ğŸ‘‹ Bonjour ! Je suis votre conseiller beautÃ© virtuel. Je peux vous aider Ã  trouver les produits parfaits pour votre type de peau.\n\nComment puis-je vous aider aujourd'hui ?",
                quickReplies: [
                    { text: "ğŸ‘ï¸ Diagnostic peau", query: "type de peau" },
                    { text: "âš¡ ProblÃ¨me spÃ©cifique", query: "acnÃ©" },
                    { text: "ğŸ§´ Ã‰tablir une routine", query: "routine" },
                    { text: "ğŸ”¥ Voir les promos", query: "promotions" }
                ]
            };
        }

        getThankYouResponse() {
            return {
                text: "Avec plaisir ! ğŸ˜Š N'hÃ©sitez pas si vous avez d'autres questions. Bonne dÃ©couverte de nos produits !",
                quickReplies: [
                    { text: "ğŸ”„ Autre question", query: "aide" },
                    { text: "ğŸ›’ Voir le catalogue", query: "catalogue" }
                ]
            };
        }
    }

    // Initialisation du chatbot
    document.addEventListener('DOMContentLoaded', function() {
        const chatbot = new EnhancedChatbotAI();
        
        // Ã‰lÃ©ments DOM
        const toggleBtn = document.getElementById('chatbot-toggle');
        const closeBtn = document.getElementById('chatbot-close');
        const chatWindow = document.getElementById('chatbot-window');
        const sendBtn = document.getElementById('chatbot-send');
        const chatInput = document.getElementById('chatbot-input');
        const messagesContainer = document.getElementById('chatbot-messages');
        
        // Variables d'Ã©tat
        let isChatOpen = false;
        
        // Message de bienvenue initial
        const welcomeMessages = [
            "ğŸ‘‹ Bonjour ! Je suis votre conseiller beautÃ© virtuel. Je peux vous aider Ã  trouver les produits parfaits pour votre peau.",
            "ğŸŒŸ Bienvenue ! Dites-moi votre type de peau ou vos prÃ©occupations, je vous recommanderai les meilleurs produits.",
            "ğŸ’« Salut ! Besoin d'aide pour choisir vos soins ? Je connais tous nos produits sur le bout des doigts !"
        ];
        
        const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
        
        // Ajouter le message de bienvenue
        const welcomeMessage = document.createElement('div');
        welcomeMessage.className = 'message bot';
        welcomeMessage.innerHTML = `
            <div class="message-content">${randomWelcome}</div>
            <div class="quick-replies">
                <button class="quick-reply" data-query="Peau sensible">ğŸ‘ï¸ Peau sensible</button>
                <button class="quick-reply" data-query="AcnÃ©">âš¡ Imperfections</button>
                <button class="quick-reply" data-query="Routine">ğŸ§´ Routine</button>
                <button class="quick-reply" data-query="Livraison">ğŸ“¦ Infos pratiques</button>
            </div>
        `;
        messagesContainer.appendChild(welcomeMessage);
        
        // Ouvrir/fermer le chat
        toggleBtn.addEventListener('click', () => {
            isChatOpen = !isChatOpen;
            chatWindow.style.display = isChatOpen ? 'flex' : 'none';
            if (isChatOpen) {
                chatInput.focus();
                scrollToBottom();
            }
        });
        
        closeBtn.addEventListener('click', () => {
            isChatOpen = false;
            chatWindow.style.display = 'none';
        });
        
        // Envoyer un message
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Ajouter le message utilisateur
            addMessage(message, 'user');
            chatInput.value = '';
            
            // Simulation de "typing"
            showTypingIndicator();
            
            // RÃ©ponse du chatbot
            setTimeout(() => {
                removeTypingIndicator();
                const response = chatbot.processMessage(message);
                displayBotResponse(response);
            }, 800);
        }
        
        // Ã‰vÃ©nements d'envoi
        sendBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // RÃ©ponses rapides
        messagesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-reply')) {
                const query = e.target.dataset.query;
                addMessage(query, 'user');
                
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const response = chatbot.processMessage(query);
                    displayBotResponse(response);
                }, 600);
            }
        });
        
        // GÃ©rer les actions produits
        function handleProductAction(event) {
            event.stopPropagation();
            const productId = event.currentTarget.dataset.id || 
                            event.currentTarget.closest('.product-card')?.dataset.productId;
            const action = event.currentTarget.dataset.action || 'view';
            
            if (productId) {
                const product = productKnowledgeBase.products.find(p => p.id == productId);
                if (product) {
                    if (action === 'cart') {
                        // Backend Integration for Cart - Use GET instead of POST
                        fetch(`/Cart/AddToCart?productId=${productId}&quantity=1`, { method: 'GET' })
                        .then(res => {
                             if(res.ok) {
                                addMessage(`Ajouter "${product.name}" au panier`, 'user');
                                setTimeout(() => {
                                    const response = {
                                        text: `âœ… "${product.name}" a Ã©tÃ© ajoutÃ© Ã  votre panier !\nSouhaitez-vous continuer vos achats ?`,
                                        quickReplies: [
                                            { text: "ğŸ›’ Voir panier", query: "panier" },
                                            { text: "ğŸ” Continuer", query: "recommandations" },
                                            { text: "ğŸ’³ Commander", query: "commander" }
                                        ]
                                    };
                                    displayBotResponse(response);
                                    // Update cart badge if needed
                                    // document.location.reload(); // Simple way to update badge, or fetch count
                                }, 500);
                             } else {
                                console.error("Error adding to cart");
                             }
                        });

                    } else {
                        // Afficher plus de dÃ©tails
                        addMessage(`DÃ©tails ${product.name}`, 'user');
                        setTimeout(() => {
                            const detailedResponse = {
                                text: `ğŸ“‹ **${product.name}**\n\nğŸ’° Prix : ${product.price}â‚¬\nâ­ Note : ${product.rating}/5\nğŸ“¦ En stock\n\n**Description :**\nProduit de qualitÃ© supÃ©rieure.\n\n**Conseil d'utilisation :**\nUtiliser quotidiennement.`,
                                quickReplies: [
                                    { text: "ğŸ›’ Ajouter au panier", query: `panier ${product.id}` },
                                    { text: "â­ Favoris", query: `favoris ${product.id}` },
                                    { text: "ğŸ” Similaires", query: `similaires ${product.id}` }
                                ]
                            };
                            displayBotResponse(detailedResponse);
                        }, 500);
                    }
                }
            }
        }
        
        // Fonctions d'affichage
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function displayBotResponse(response) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            let contentHTML = `<div class="message-content">${response.text.replace(/\n/g, '<br>')}</div>`;
            
            // Ajouter les produits
            if (response.products && response.products.length > 0) {
                contentHTML += `
                    <div class="message-with-products">
                        ${response.products.map(product => `
                            <div class="product-card" data-product-id="${product.id}">
                                <h4>${product.name} ${product.promo ? '<span class="badge">PROMO</span>' : ''}</h4>
                                <div class="price">${product.price}â‚¬</div>
                                <div class="rating">â­ ${product.rating}/5</div>
                                <div class="action-buttons">
                                    <button class="action-button" data-action="view" data-id="${product.id}">Voir</button>
                                    <button class="action-button" data-action="cart" data-id="${product.id}">Panier</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Ajouter les quick replies
            if (response.quickReplies && response.quickReplies.length > 0) {
                contentHTML += `
                    <div class="quick-replies">
                        ${response.quickReplies.map(reply => 
                            `<button class="quick-reply" data-query="${reply.query || reply.text}">${reply.text}</button>`
                        ).join('')}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = contentHTML;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Ajouter les Ã©vÃ©nements aux nouvelles cartes produits
            messageDiv.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', handleProductAction);
            });
            
            messageDiv.querySelectorAll('.product-card').forEach(card => {
                if (!card.querySelector('.action-button')) {
                    card.addEventListener('click', () => {
                        const productId = card.dataset.productId;
                        if (productId) {
                            chatInput.value = `DÃ©tails produit ${productId}`;
                            sendMessage();
                        }
                    });
                }
            });
        }
        
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Clic sur carte produit
        messagesContainer.addEventListener('click', (e) => {
            const productCard = e.target.closest('.product-card');
            if (productCard && !e.target.closest('.action-button')) {
                const productId = productCard.dataset.productId;
                if (productId) {
                    const product = productKnowledgeBase.products.find(p => p.id == productId);
                    if (product) {
                        chatInput.value = product.name;
                        sendMessage();
                    }
                }
            }
        });
        
        // Focus automatique quand la fenÃªtre s'ouvre
        chatWindow.addEventListener('click', () => {
            chatInput.focus();
        });
    });
</script>
